<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="shortcut icon" href="../../img/file/icon.ico" /> <meta name="description" content="Blogging useful linux tips"> <link rel="canonical" href="https://wifiextender.github.io/"> <meta name="author" content="Aaron"> <title>Install Arch with full disk encryption</title> <link href="../../css/template-3/bootstrap-min.css" rel="stylesheet"> </head> <body> <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header"> <a class="navbar-brand" href="../../index.html">Home</a> <a class="navbar-brand" href="../../archive.html">Archive</a> </div> </div> </nav> <div class="container"> <div class="row"> <div class="col-lg-8"> <div class="panel panel-primary"> <div class="panel-body"><h1>Install Arch with full disk encryption</h1><div class="date-left"><span class="label label-default">2015-04-23 Author: Aaron</span></div><div class="articleline2"></div><br /><br /><p>In today's post we are going to install Arch Linux with full disk encryption.</p><p>Before we proceed, I want you to backup your existing data.</p><p>In the previous post we learnt what dm-crypt and LUKS are and how to encrypt single disk partition. While in the post today we will take a slightly different approach to encrypt the whole disk with dm-crypt LUKS and install Archlinux on it.</p><p>Let's start with disk erasing. Run <strong>lsblk</strong> to find your primary disk and replace <code>/dev/sda</code> where needed:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> shred --verbose --random-source=/dev/urandom --iterations=3 /dev/sda</pre><p>I ran the above command with '--iterations=15' on my 120GB SSD overnight and it finished after 7 hours.</p><p>Once done, partition the disk. Unless your motherboard is using UEFI firmware, make sure to select 'dos' (msdos) label, otherwise go with the 'gpt' when you type:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> cfdisk /dev/sda</pre><img src="https://wifiextender.github.io/img/file/archlinux-luks/dos-label.png" alt="" /><p>After that create boot loader partition:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> New-> Partition Size: 100M -> primary -> Bootable</pre><p>The last one will be the root partition. The partition size should be automatically set to your remaining free space.</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> New-> Partition Size: xxxGB -> primary</pre><p>Write the changes and quit from cfdisk.</p><p>In order to boot your encrypted root partition, the boot loader partition <code>/dev/sda1</code> that will be mounted in <strong>/boot</strong> won't be encrypted. I will place couple links at the end of this post that will guide you how to encrypt and even move the boot partition on a CD/DVD/USB.</p><p>Create cryptographic device mapper device in LUKS encryption mode:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> cryptsetup --verbose --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 5000 --use-random luksFormat /dev/sda2</pre><p>Unlock the partition, note that <strong>cryptroot</strong> will be the device mapper name that we will operate on.</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> cryptsetup open --type luks /dev/sda2 cryptroot</pre><p>Create the boot and root file systems:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mkfs.ext4 /dev/sda1<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mkfs.ext4 /dev/mapper/cryptroot</p></pre><p>Mount them:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mount -t ext4 /dev/mapper/cryptroot /mnt<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mkdir -p /mnt/boot</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mount -t ext4 /dev/sda1 /mnt/boot</p></pre><p>Install the base and base-devel systems:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> pacstrap -i /mnt base base-devel</pre><p>Generate the fstab:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> genfstab -U -p /mnt >> /mnt/etc/fstab</pre><p>Chroot to configure the base system:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> arch-chroot /mnt</pre><p>Uncomment the <strong>en_US</strong> locale:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/g' /etc/locale.gen</pre><p>Generate the locale:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> locale-gen</pre><p>Create configuration file that would instruct the system what language locale it should be using:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo LANG=en_US.UTF-8 > /etc/locale.conf</pre><p>Export the locale</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> export LANG=en_US.UTF-8</pre><p>Create a symbolic link with the desired time zone:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> ln -s /usr/share/zoneinfo/Europe/Berlin /etc/localtime</pre><p>Set the hardware clock to UTC:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> hwclock --systohc --utc</pre><p>Set the desired hostname:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo CookieMonster > /etc/hostname</pre><p>Set the root password:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> passwd</pre><p>Add a system user:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> useradd -m -g users -G wheel,games,power,optical,storage,scanner,lp,audio,video -s /bin/bash username</pre><p>Set the system user password:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> passwd username</pre><p>Install sudo (base-devel) and the boot loader grub and os-prober:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> pacman -S sudo grub-bios os-prober</pre><p>Allow the system user to use sudo and run commands (temporary) as root:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> EDITOR=nano visudo</pre><p>Press CTRL + W and type wheel, then uncomment the following line:</p><img src="https://wifiextender.github.io/img/file/archlinux/9.png" alt="" /><p>Add the following kernel parameter to be able to unlock your LUKS encrypted root partition during system startup:</p><img src="https://wifiextender.github.io/img/file/archlinux-luks/kern-param.png" alt="" /><p>Add <strong>encrypt</strong> hook:</p><img src="https://wifiextender.github.io/img/file/archlinux-luks/mkinitcpio-hook.png" alt="" /><p>Since we added new hook in the mkinitcpio configuration file, we should re-generate our initrams image (ramdisk):</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mkinitcpio -p linux</pre><p>Install grub and save it's configuration file:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> grub-install --recheck /dev/sda<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> grub-mkconfig --output /boot/grub/grub.cfg</p></pre><p>Exit from chroot, unmount the partitions, close the device and reboot (remove the installation media):</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> exit<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> umount -R /mnt/boot</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> umount -R /mnt</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> cryptsetup close cryptroot</p><p><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> systemctl reboot</p></pre><p>Once you type in your password and login as system user, start dhcpcd.</p><img src="https://wifiextender.github.io/img/file/archlinux-luks/unlock-root.png" alt="" /><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> systemctl start dhcpcd<p><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> ping -c2 youtube.com</p></pre><p>Install Xorg and copy <strong>.xinitrc</strong> over your $HOME dir:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> pacman -S xorg-server xorg-server-utils xorg-xinit mesa xterm xorg-twm xorg-xclock<p><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> cp /etc/X11/xinit/xinitrc ~/.xinitrc</p></pre><p>There is a special wiki page that contains useful information for the GPU drivers, check it out <a href="https://wiki.archlinux.org/index.php/xorg#Driver_installation" target="_blank">https://wiki.archlinux.org/index.php/xorg#Driver_installation</a> and if it happens your GPU brand to be amd/ati, intel or nvidia install the appropriate drivers listed there.</p><p>Type <code>startx</code> and you should see couple terminals side-by-side, now type <code>exit</code></p><p>Comment in the following lines in <strong>.xinitrc</strong> and add some to specify that we want the <strong>xfce</strong> desktop environment to be started upon successful login:</p><img src="https://wifiextender.github.io/img/file/archlinux-luks/add-xfce-session.png" alt="" /><p>Install xfce, external display manager and network manager:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> pacman -S slim archlinux-themes-slim xfce4 networkmanager network-manager-applet</pre><p>Exchange the default slim theme:</p><img src="https://wifiextender.github.io/img/file/archlinux-luks/slim-theme.png" alt="" /><p>Stop dhcpcd, enable slim, enable NetworkManager, startx:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> systemctl stop dhcpcd<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> systemctl enable NetworkManager</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> systemctl enable slim</p><p><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> startx</p></pre><p>That was it, hope you enjoyed this post.</p><img src="https://wifiextender.github.io/img/file/archlinux-luks/xfce-final-result.png" alt="" /><p>If you ever manage to f*ck up your system and have to chroot from removable media, the order is:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> cryptsetup open --type luks /dev/sda2 cryptroot<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mount -t ext4 /dev/mapper/cryptroot /mnt</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mount -t ext4 /dev/sda1 /mnt/boot</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> arch-chroot /mnt</p></pre><p>To unmount them:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> umount -R /mnt/boot<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> umount -R /mnt</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> cryptsetup close cryptroot</p></pre><p>The promised links, read the 8th and 9th links carefully if you got SSD:</p><p><a href="http://crunchbang.org/forums/viewtopic.php?id=24722" target="_blank">link 1</a>, <a href="https://bbs.archlinux.org/viewtopic.php?pid=943338" target="_blank">link 2</a>, <a href="https://wiki.archlinux.org/index.php/Dm-crypt/Device_encryption" target="_blank">link 3</a>, <a href="https://wiki.archlinux.org/index.php/Dm-crypt" target="_blank">link 4</a>, <a href="https://wiki.gentoo.org/wiki/DM-Crypt_LUKS" target="_blank">link 5</a>, <a href="https://wiki.gentoo.org/wiki/Dm-crypt" target="_blank">link 6</a>, <a href="https://help.ubuntu.com/community/EncryptedFilesystemHowto" target="_blank">link 7</a>, <a href="https://wiki.archlinux.org/index.php/Solid_State_Drives#Enable_TRIM_for_dm-crypt" target="_blank">link 8</a>, <a href="http://thunk.org/tytso/blog/2009/03/01/ssds-journaling-and-noatimerelatime/" target="_blank">link 9</a>, <a href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions" target="_blank">link 10</a></p> </div></div></div> <div class="col-lg-4"> <div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title">Popular Tags</h3></div><div class="panel-body"><div id="popular_tagz"></div></div></div> <div class="list-group"><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title">Recent Posts</h3></div><div id="recent_poztz"></div></div></div>  </div> </div> <footer> <div class="row"> <div class="col-lg-12"> Powered by <a href="https://github.com/wifiextender/blogfy" target="_blank">Python</a>, <a href="javascript: void(0);" onclick="showOS();">OS test</a> </div> </div> </footer> </div> <script src="../../css/js/scr.js" async></script>  </body> </html>
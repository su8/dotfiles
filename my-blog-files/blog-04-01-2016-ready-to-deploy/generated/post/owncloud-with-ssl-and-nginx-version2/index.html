<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="shortcut icon" href="../../img/file/icon.ico" /> <meta name="description" content="Blogging useful linux tips"> <link rel="canonical" href="https://wifiextender.github.io/"> <meta name="author" content="Aaron"> <title>Install ownCloud with SSL and Nginx in CentOS (version 3)</title> <link href="../../css/template-3/bootstrap-min.css" rel="stylesheet"> </head> <body> <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header"> <a class="navbar-brand" href="../../index.html">Home</a> <a class="navbar-brand" href="../../archive.html">Archive</a> </div> </div> </nav> <div class="container"> <div class="row"> <div class="col-lg-8"> <div class="panel panel-primary"> <div class="panel-body"><h1>Install ownCloud with SSL and Nginx in CentOS (version 3)</h1><div class="date-left"><span class="label label-default">2014-06-05 Author: Aaron</span></div><div class="articleline2"></div><br /><br /><p>CentOS has upgraded a lot packages, and the post that I've wrote 1 year ago no longer works in CentOS 6.5 updated up-to-date.</p><p>I did a research and it looks like this will be the first tutorial in 2014 how to install owncloud in centos with nginx, postgresql and ssl. You ain't gonna find CentOS and owncloud installation with nginx nowadays, because most people don't know how to resolve simple issues.</p><p>My server was affected and this is the reason that made me to write this post today.</p><p>The packages in the EPEL and CentOS repos are obsolete, while nginx, postgresql and owncloud requires bit newer packages. You'll just stay at the log-in page without getting access to your files, being left to scratch your head and asking yourself wtf just happened. The log files won't show you where the issue comes from nor the owncloud itself.</p><p>The owncloud requirements are:</p><p>PostgreSQL >= 9.0, but in EPEL is 8.8, it requires php 5.3.3 as minimum but it does not works with that version, also all of these newer packages will require latest stable nginx version.</p><p>The first thing that we should do is to remove all mysql libraries.</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> yum remove mysql* mysql-server mysql-devel mysql-libs</pre><p>As usual, we will install 3rd party repos, such as epel, remi and the new one: latest postgresql</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> rpm -ivh http://dl.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> rpm -ivh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> rpm -ivh http://yum.postgresql.org/9.3/redhat/rhel-6-i386/pgdg-centos93-9.3-1.noarch.rpm</p></pre><p>Edit the epel repository and make sure that the top is <code>enabled=1</code></p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> vi /etc/yum.repos.d/epel.repo</pre><p>Do the same with the remi repo, but make sure to enable php version 5.6, <code>vi /etc/yum.repos.d/remi.repo</code></p><img src="https://wifiextender.github.io/img/file/centos_owncloud2/remi-repo.png" alt= "" /><br /><img src="https://wifiextender.github.io/img/file/centos_owncloud2/remi-repo1.png" alt= "" /><br /><p>Create a nginx repo configuration file <code>vi /etc/yum.repos.d/nginx.repo</code> and add:</p><pre>[nginx]<p>name=nginx repo</p><p>baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</p><p>gpgcheck=0</p><p>enabled=1</p></pre><p>Update your CentOS server in order to add those 3rd party repos <code>yum update</code></p><p>Install the following packages in order to satisfy the owncloud requirements:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> yum install nginx postgresql93 postgresql93-libs postgresql93-server wget php-fpm php-gd php-ldap php-pear php-xml php-xmlrpc php-magickwand php-magpierss php-mbstring php-mcrypt php-shout php-snmp php-soap php-tidy php-pgsql php-pdo</pre><p>Start the PostgreSQL, start nginx temporary and add it to system startup services with chkconfig</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service postgresql-9.3 initdb<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service postgresql-9.3 start</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> chkconfig postgresql-9.3 on</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service nginx start</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> chkconfig nginx on</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service nginx stop</p></pre><p>Create new PostgreSQL user and database.</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> su - -c "psql" postgres<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> CREATE USER cloud WITH PASSWORD 'userpass';</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> CREATE DATABASE cloudbase OWNER cloud ENCODING 'UTF8';</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> GRANT ALL PRIVILEGES ON DATABASE cloudbase TO cloud;</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> \q</p></pre><p>Check and remember your timezone <code>cat /etc/sysconfig/clock</code></p><p>Edit the php configuration file <code>vi /etc/php.ini</code></p><pre># search for post_max_size and make it<p>post_max_size = 2G</p><p># search for cgi.fix_pathinfo, uncomment it and make it</p><p>cgi.fix_pathinfo = 0</p><p># search for upload_max_filesize and make it</p><p>upload_max_filesize = 2G</p><p># search for date.timezone, uncomment it and make it</p><p>date.timezone = "your/timezone"</p></pre><p>Edit the php-fpm configuration file in order to use tcp instead unix socket <code>vi /etc/php-fpm.d/www.conf</code></p><p>Make sure that <strong>listen</strong> is not pointing /var/run/php-fpm/php-fpm.sock</p><pre>listen = 127.0.0.1:9000</pre><p>Start the php-fpm service</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> chkconfig php-fpm on<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service php-fpm start</p></pre><p>Edit the postgresql config file to allow password logins: <code>vi /var/lib/pgsql/9.3/data/pg_hba.conf</code>, change ident with password - notice the cursor in the following picture:</p><img src="https://wifiextender.github.io/img/file/centos_owncloud2/postgresqlconf.png" alt= "" /><br /><p>Restart the postgresql database <code>service postgresql-9.3 restart</code></p><p>Create empty folder where we will store our SSL certs</p><pre><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> cd /etc/nginx<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mkdir -p cert</p></pre><p>If you are familiar with apache virtual hosts, then the next file that you will have to create is exactly that.</p><pre><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> cd conf.d<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> vi cloud.conf</p></pre><pre><p>upstream php-handler {</p>        <p>server 127.0.0.1:9000;</p>        <p>#server unix:/var/run/php5-fpm.sock;</p><p>}</p><p></p><p>server {</p><p>        listen 80;</p><p>        server_name 10.10.10.110; # replace with your domain name or internal server ip</p><p>        return 301 https://$server_name$request_uri;  # enforce https</p><p>}</p><p></p><p>server {</p><p>        listen 443 ssl;</p><p>        server_name 10.10.10.110; # replace with your domain name or internal server ip</p><p></p><p>        ssl_certificate /etc/nginx/cert/server.crt;</p><p>        ssl_certificate_key /etc/nginx/cert/server.key;</p><p></p><p>        # Path to the root of your installation</p><p>        root /var/www/owncloud/;</p><p></p><p>        client_max_body_size 10G; # set max upload size</p><p>        fastcgi_buffers 64 4K;</p><p></p><p>        rewrite ^/caldav(.*)$ /remote.php/caldav$1 redirect;</p><p>        rewrite ^/carddav(.*)$ /remote.php/carddav$1 redirect;</p><p>        rewrite ^/webdav(.*)$ /remote.php/webdav$1 redirect;</p><p></p><p>        index index.php;</p><p>        error_page 403 /core/templates/403.php;</p><p>        error_page 404 /core/templates/404.php;</p><p></p><p>        location = /robots.txt {</p><p>            allow all;</p><p>            log_not_found off;</p><p>            access_log off;</p><p>        }</p><p></p><p>        location ~ ^/(data|config|\.ht|db_structure\.xml|README) {</p><p>                deny all;</p><p>        }</p><p></p><p>        location / {</p><p>                # The following 2 rules are only needed with webfinger</p><p>                rewrite ^/.well-known/host-meta /public.php?service=host-meta last;</p><p>                rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json last;</p><p></p><p>                rewrite ^/.well-known/carddav /remote.php/carddav/ redirect;</p><p>                rewrite ^/.well-known/caldav /remote.php/caldav/ redirect;</p><p></p><p>                rewrite ^(/core/doc/[^\/]+/)$ $1/index.html;</p><p></p><p>                try_files $uri $uri/ index.php;</p><p>        }</p><p></p><p>        location ~ ^(.+?\.php)(/.*)?$ {</p><p>                try_files $1 = 404;</p><p></p><p>                include fastcgi_params;</p><p>                fastcgi_param SCRIPT_FILENAME $document_root$1;</p><p>                fastcgi_param PATH_INFO $2;</p><p>                fastcgi_param HTTPS on;</p><p>                fastcgi_pass php-handler;</p><p>        }</p><p></p><p>        # Optional: set long EXPIRES header on static assets</p><p>        location ~* ^.+\.(jpg|jpeg|gif|bmp|ico|png|css|js|swf)$ {</p><p>                expires 30d;</p><p>                # Optional: Don't log access to assets</p><p>                access_log off;</p><p>        }</p><p></p><p>}</p></pre><p>I've uploaded that nginx configuration file to my website, so instead writing it manually just type:</p><pre>wget https://wifiextender.github.io/img/file/centos_owncloud2/nginx1-6.conf.txt</pre><p>Rename it to something like <strong>cloud.conf</strong></p><p>As you specified in the nginx "virtual host" above, our ownCloud server will be using SSL, so let's create these certificates, shall we ?</p><pre><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> cd ..<p><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> cd cert</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> openssl req -x509 -nodes -sha384 -days 3650 -newkey rsa:4096 -keyout server.key -out server.crt</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> chmod 600 server.key</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> chmod 600 server.csr</p></pre><p>Next, download, extract the owncloud archive and set permissions for the owncloud folder. Please note that we will download the development version of owncloud.</p><pre><code2 style="font-weight: bold; color: rgb(42,159,214);">$</code2> cd /var/www<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> wget http://download.owncloud.org/community/daily/owncloud-daily-master.tar.bz2</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> tar xjf owncloud-daily-master.tar.bz2</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> mkdir -p owncloud/data</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> chmod 755 owncloud/data</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> chmod 755 owncloud/config/</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> chown -R root:apache owncloud</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> rm -rf owncloud-daily-master.tar.bz2</p></pre><p>Allow incomming tcp connections to your server ports: 80 and 443. If you or someone else call your server internal ip it will be redirected to https://yourserverinternalip, because you specified that in the nginx "virtual host" earlier.</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> iptables -I INPUT 4 -p tcp -d 10.10.10.110 --dport 80 -j ACCEPT<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> iptables -I INPUT 4 -p tcp -d 10.10.10.110 --dport 443 -j ACCEPT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service iptables save</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service iptables restart</p></pre><p>Restart PostgreSQL for last time, and start nginx with the newer configuration:</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service postgresql-9.3 restart<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service nginx start</p></pre><p>That's all, open up your browser and point your server ip. Choose whatever log-in name and password you like.</p><img src="https://wifiextender.github.io/img/file/centos_owncloud2/owncloud7-finished.png" alt="" /> </div></div></div> <div class="col-lg-4"> <div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title">Popular Tags</h3></div><div class="panel-body"><div id="popular_tagz"></div></div></div> <div class="list-group"><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title">Recent Posts</h3></div><div id="recent_poztz"></div></div></div>  </div> </div> <footer> <div class="row"> <div class="col-lg-12"> Powered by <a href="https://github.com/wifiextender/blogfy" target="_blank">Python</a>, <a href="javascript: void(0);" onclick="showOS();">OS test</a> </div> </div> </footer> </div> <script src="../../css/js/scr.js" async></script>  </body> </html>
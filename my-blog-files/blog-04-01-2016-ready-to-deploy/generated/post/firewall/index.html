<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="shortcut icon" href="../../img/file/icon.ico" /> <meta name="description" content="Blogging useful linux tips"> <link rel="canonical" href="https://wifiextender.github.io/"> <meta name="author" content="Aaron"> <title>TCP/IP stack hardening</title> <link href="../../css/template-3/bootstrap-min.css" rel="stylesheet"> </head> <body> <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header"> <a class="navbar-brand" href="../../index.html">Home</a> <a class="navbar-brand" href="../../archive.html">Archive</a> </div> </div> </nav> <div class="container"> <div class="row"> <div class="col-lg-8"> <div class="panel panel-primary"> <div class="panel-body"><h1>TCP/IP stack hardening</h1><div class="date-left"><span class="label label-default">2014-05-17 Author: Aaron</span></div><div class="articleline2"></div><br /><br /><p>Denial of service (Dos) prevention should be one of the first things that you should do once a new operating system is installed.</p><p>If you have a server iptables is the way to go, if you want to prevent DoS on your desktop then ufw will ease the whole process.</p><p>Let's begin with small ufw configuration for your desktop pc.</p><p>Edit <code>/etc/ufw/sysctl.conf</code></p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/icmp_echo_ignore_broadcast=1<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/icmp_ignore_bogus_error_responses=1</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/icmp_echo_ignore_all=1</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/default/accept_redirects=0</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/all/accept_redirects=0</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/tcp_syncookies=1</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/conf/default/log_martians=1</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/conf/all/log_martians=1</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/conf/default/send_redirects=0</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/conf/all/send_redirects=0</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/conf/all/accept_source_route=0</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/conf/default/accept_source_route=0</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/conf/default/rp_filter=1</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> net/ipv4/conf/all/rp_filter=1</p></pre><p>Restart ufw with <code>ufw disable</code> and then <code>ufw enable</code>, now go to <a href="https://www.grc.com/x/ne.dll?bh0bkyd2" target="_blank">ShieldsUP</a>, click proceed on some of the buttons and look for <strong>All Service Ports</strong>, click it and wait till they scan your ports and you should pass the test with <strong>"TruStealth"</strong> rating.</p><p>Moving to iptable rules configuration for your server. I use the same configuration for my centos OwnCloud server, save it as <strong>fw.sh</strong> and then configure the NIC to match yours, mine is <code>eth0</code> yours could be different</p><pre><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> #!/bin/bash<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -F</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -X</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -t nat -F</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -t nat -X</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -t mangle -F</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -t mangle -X</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> modprobe ip_conntrack </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> NIC="eth0"  </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -i lo -j ACCEPT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A OUTPUT -o lo -j ACCEPT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -P INPUT DROP</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -P OUTPUT DROP</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -P FORWARD DROP </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -i ${NIC} -p tcp ! --syn -m state --state NEW  -m limit --limit 5/m --limit-burst 7 -j LOG --log-level 4 --log-prefix "Drop Syn" </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -i ${NIC} -p tcp ! --syn -m state --state NEW -j DROP<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -i ${NIC} -f  -m limit --limit 5/m --limit-burst 7 -j LOG --log-level 4 --log-prefix "Fragments Packets"</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -i ${NIC} -f -j DROP  </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags ALL ALL -j DROP </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags ALL NONE -m limit --limit 5/m --limit-burst 7 -j LOG --log-level 4 --log-prefix "NULL Packets"</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags ALL NONE -j DROP</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags SYN,RST SYN,RST -j DROP </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags SYN,FIN SYN,FIN -m limit --limit 5/m --limit-burst 7 -j LOG --log-level 4 --log-prefix "XMAS Packets"</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags FIN,ACK FIN -m limit --limit 5/m --limit-burst 7 -j LOG --log-level 4 --log-prefix "Fin Packets Scan"</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags FIN,ACK FIN -j DROP</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables  -A INPUT -i ${NIC} -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP  </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -i ${NIC} -m state --state ESTABLISHED,RELATED -j ACCEPT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A OUTPUT -o ${NIC} -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -p tcp --destination-port 22 -j REJECT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A OUTPUT -p tcp --sport 22 -j REJECT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> # Whenever you change the ssh port make sure to uncomment the line below and change the port</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> # iptables -I INPUT 4 -p tcp -d 192.168.10.30 --dport 3789 -j ACCEPT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> #If you only need remote access from one IP address (say from work to your home server), then consider filtering connections at your firewall by either adding a firewall rule on your router or in iptables to limit access on port 3789 to only that specific IP address. For example, in iptables this could be achieved with the following type of rule:</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> # iptables -A INPUT -p tcp -s 72.232.194.162 --dport 3789 -j ACCEPT </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -p icmp --icmp-type 8 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A OUTPUT -p icmp --icmp-type 0 -m state --state ESTABLISHED,RELATED -j ACCEPT </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -p tcp -i ${NIC} --dport 137:139 -j REJECT</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -p udp -i ${NIC} --dport 137:139 -j REJECT </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -j LOG</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A FORWARD -j LOG</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> /sbin/iptables -A INPUT -j DROP</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/ip_forward</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 64000 > /proc/sys/net/ipv4/ipfrag_high_thresh</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 48000 > /proc/sys/net/ipv4/ipfrag_low_thresh </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 10 > /proc/sys/net/ipv4/ipfrag_time </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 5 > /proc/sys/net/ipv4/icmp_ratelimit</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/tcp_syncookies</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 0 > /proc/sys/net/ipv4/conf/eth0/accept_source_route</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 0 > /proc/sys/net/ipv4/conf/eth0/accept_redirects </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/conf/eth0/log_martians </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 10 > /proc/sys/net/ipv4/neigh/eth0/locktime</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 0 > /proc/sys/net/ipv4/conf/eth0/proxy_arp</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 50 > /proc/sys/net/ipv4/neigh/eth0/gc_stale_time</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 0 > /proc/sys/net/ipv4/conf/eth0/send_redirects</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 0 > /proc/sys/net/ipv4/conf/eth0/secure_redirects</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/icmp_ignore_bogus_error_responses</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 5 > /proc/sys/net/ipv4/igmp_max_memberships</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 2 > /proc/sys/net/ipv4/igmp_max_msf</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1024 > /proc/sys/net/ipv4/tcp_max_orphans</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 2 > /proc/sys/net/ipv4/tcp_syn_retries</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 2 > /proc/sys/net/ipv4/tcp_synack_retries</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/tcp_abort_on_overflow</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 10 > /proc/sys/net/ipv4/tcp_fin_timeout</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 0 > /proc/sys/net/ipv4/route/redirect_number</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/conf/all/rp_filter</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/conf/eth0/rp_filter</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 0 > /proc/sys/net/ipv4/conf/all/accept_source_route</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 61 > /proc/sys/net/ipv4/ip_default_ttl</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo "1800" > /proc/sys/net/ipv4/tcp_keepalive_time</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo "0" > /proc/sys/net/ipv4/tcp_window_scaling</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo "0" > /proc/sys/net/ipv4/tcp_sack</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 4096 87380 4194304 >/proc/sys/net/ipv4/tcp_rmem</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 4096 87380 4194304 >/proc/sys/net/ipv4/tcp_wmem</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo 1 > /proc/sys/net/ipv4/tcp_ecn</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> echo "30000 60000" > /proc/sys/net/ipv4/ip_local_port_range </p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service iptables save</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> service iptables restart</p><p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> exit 0</p></pre><p>These iptables rules are really powerful and I won't recommend you to use them for your desktop pc as they will limit a lot of your applications that you use on daily basis.</p><p>If you try to ping the server it will show 100% packet loss which means it drops ping requests.</p><p>Even if you have open ports, by scanning the server with nmap they will be shown as <strong>closed</strong>, don't believe me ?</p><pre># Replace 192.168.10.30 with your server internal ip<p><code2 style="font-weight: bold; color: rgb(239,41,41);">#</code2> nmap -sV -O -PN 192.168.10.30</p></pre> </div></div></div> <div class="col-lg-4"> <div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title">Popular Tags</h3></div><div class="panel-body"><div id="popular_tagz"></div></div></div> <div class="list-group"><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title">Recent Posts</h3></div><div id="recent_poztz"></div></div></div>  </div> </div> <footer> <div class="row"> <div class="col-lg-12"> Powered by <a href="https://github.com/wifiextender/blogfy" target="_blank">Python</a>, <a href="javascript: void(0);" onclick="showOS();">OS test</a> </div> </div> </footer> </div> <script src="../../css/js/scr.js" async></script>  </body> </html>